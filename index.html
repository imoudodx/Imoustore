<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>imou store 🇹🇳 - متجر الحسابات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #111827; color: #f9fafb; }
        .card { background-color: #1f2937; border: 1px solid #374151; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); transition: opacity 0.3s ease; }
        .modal-content { background-color: #1f2937; transition: transform 0.3s ease; }
        .btn-primary { background-color: #3b82f6; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-gray-800 shadow-lg py-4 px-6 sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white">imou store <span class="text-red-500">🇹🇳</span></h1>
            <div class="flex gap-2">
                <button id="filterBtn" class="btn-secondary py-2 px-4 rounded-lg text-sm">عرض آخر 3 ساعات</button>
                <button id="addProductBtn" class="btn-primary py-2 px-4 rounded-lg font-semibold flex items-center justify-center gap-2">
                    <i class="fas fa-plus-circle"></i> <span>أضف منتج</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-6">
        <div id="loader" class="loader"></div>
        <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        <div id="noResults" class="text-center py-16 hidden">
            <i class="fas fa-box-open fa-4x text-gray-500 mb-4"></i>
            <h2 class="text-2xl font-semibold text-gray-400">لا توجد منتجات معروضة حاليًا.</h2>
        </div>
    </main>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="fixed inset-0 z-50 modal-backdrop items-center justify-center hidden opacity-0">
        <div class="modal-content w-11/12 md:max-w-lg mx-auto rounded-xl shadow-lg p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b border-gray-600 pb-3 mb-4 sticky top-0 bg-inherit">
                <h3 class="text-2xl font-bold">إضافة منتج جديد</h3>
                <button class="close-modal-btn text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <input type="text" id="productName" placeholder="اسم المنتج" class="form-input w-full p-3 rounded-lg">
                <input type="number" id="productPrice" placeholder="السعر بالدينار التونسي" class="form-input w-full p-3 rounded-lg">
                <textarea id="productDesc" placeholder="وصف المنتج" class="form-input w-full p-3 rounded-lg h-24"></textarea>
                <input type="text" id="facebookLink" placeholder="رابط فيسبوك للتواصل" class="form-input w-full p-3 rounded-lg">
                <div>
                    <label class="block mb-2 text-sm font-medium">ارفع صور المنتج</label>
                    <input type="file" id="productImages" accept="image/*" class="form-input w-full p-2" multiple>
                </div>
                <button id="submitProduct" class="btn-primary w-full p-3 rounded-lg font-bold">نشر المنتج</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCLOAJl7SheS1akKNf9wKzqElVZk2U6eEc",
          authDomain: "imou-store.firebaseapp.com",
          projectId: "imou-store",
          storageBucket: "imou-store.appspot.com",
          messagingSenderId: "811468411589",
          appId: "1:811468411589:web:d25f45b11e0f29002996ac",
          measurementId: "G-NMZRPEQ45Q"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Global Variables ---
        const urlParams = new URLSearchParams(window.location.search);
        const isAdmin = urlParams.get('admin') === 'true';
        const productsCollection = collection(db, "products");

        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const productsGrid = document.getElementById('productsGrid');
        const noResults = document.getElementById('noResults');
        const addProductBtn = document.getElementById('addProductBtn');
        const addProductModal = document.getElementById('addProductModal');
        const submitProductBtn = document.getElementById('submitProduct');
        const filterBtn = document.getElementById('filterBtn');

        // --- Functions ---
        
        // Function to convert a file to a Base64 string
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Function to render products on the page
        function renderProducts(products) {
            productsGrid.innerHTML = '';
            noResults.style.display = products.length === 0 ? 'block' : 'none';
            loader.style.display = 'none';

            products.forEach(product => {
                const adminDeleteBtn = isAdmin ? `<button data-id="${product.id}" class="admin-delete-btn mt-2 w-full bg-red-600 text-white py-1 rounded-lg">حذف</button>` : '';
                const card = document.createElement('div');
                card.className = 'card rounded-lg overflow-hidden shadow-lg';
                card.innerHTML = `
                    <img class="w-full h-48 object-cover" src="${product.images[0]}" alt="${product.name}">
                    <div class="p-4">
                        <h3 class="font-bold text-lg truncate">${product.name}</h3>
                        <p class="text-blue-400 font-bold text-xl my-2">${product.price} دينار</p>
                        <p class="text-gray-400 text-sm h-10 overflow-hidden">${product.desc}</p>
                        <a href="${product.facebook}" target="_blank" class="mt-4 block w-full text-center btn-secondary py-2 rounded-lg">تواصل مع البائع</a>
                        ${adminDeleteBtn}
                    </div>
                `;
                productsGrid.appendChild(card);
            });
        }

        // --- Firestore Real-time Listener ---
        function listenToProducts(filterDate = null) {
            loader.style.display = 'block';
            let q = query(collection(db, "products"), orderBy("createdAt", "desc"));
            
            if (filterDate) {
                q = query(collection(db, "products"), where("createdAt", ">=", filterDate), orderBy("createdAt", "desc"));
            }

            onSnapshot(q, (snapshot) => {
                const products = [];
                snapshot.forEach(doc => {
                    const productData = doc.data();
                    const productId = doc.id;
                    
                    if (productData.createdAt) { // Check if createdAt exists
                        const postDate = productData.createdAt.toDate();
                        const fortyEightHoursAgo = new Date(Date.now() - 48 * 60 * 60 * 1000);

                        // Auto-delete logic
                        if (postDate < fortyEightHoursAgo && !isAdmin) { // Admins can see all posts
                            deleteDoc(doc.ref); // Delete from Firestore
                        } else {
                            products.push({ id: productId, ...productData });
                        }
                    } else {
                        // Handle cases where createdAt is null, maybe push it to be visible or log an error
                        products.push({ id: productId, ...productData });
                    }
                });
                renderProducts(products);
            });
        }

        // --- Event Listeners ---
        addProductBtn.addEventListener('click', () => toggleModal(addProductModal, true));
        document.querySelector('.close-modal-btn').addEventListener('click', () => toggleModal(addProductModal, false));
        
        submitProductBtn.addEventListener('click', async () => {
            const name = document.getElementById('productName').value.trim();
            const price = document.getElementById('productPrice').value.trim();
            const desc = document.getElementById('productDesc').value.trim();
            const facebook = document.getElementById('facebookLink').value.trim();
            const imageFiles = document.getElementById('productImages').files;

            if (!name || !price || !desc || !facebook || imageFiles.length === 0) {
                alert('الرجاء ملء جميع الحقول ورفع صورة واحدة على الأقل.');
                return;
            }
            
            submitProductBtn.disabled = true;
            submitProductBtn.textContent = 'جاري النشر...';

            try {
                const imagePromises = Array.from(imageFiles).map(file => toBase64(file));
                const base64Images = await Promise.all(imagePromises);

                await addDoc(productsCollection, {
                    name,
                    price: Number(price),
                    desc,
                    facebook,
                    images: base64Images,
                    createdAt: serverTimestamp()
                });

                toggleModal(addProductModal, false);
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productDesc').value = '';
                document.getElementById('facebookLink').value = '';
                document.getElementById('productImages').value = '';

            } catch (error) {
                console.error("Error adding document: ", error);
                alert("حدث خطأ أثناء نشر المنتج.");
            } finally {
                submitProductBtn.disabled = false;
                submitProductBtn.textContent = 'نشر المنتج';
            }
        });

        productsGrid.addEventListener('click', async (e) => {
            if (e.target.classList.contains('admin-delete-btn')) {
                const id = e.target.dataset.id;
                if (confirm('هل أنت متأكد من حذف هذا المنشور؟')) {
                    await deleteDoc(doc(db, "products", id));
                }
            }
        });
        
        filterBtn.addEventListener('click', () => {
            const threeHoursAgo = new Date(Date.now() - 3 * 60 * 60 * 1000);
            if (filterBtn.textContent.includes('آخر 3 ساعات')) {
                listenToProducts(threeHoursAgo);
                filterBtn.textContent = 'عرض كل المنشورات';
            } else {
                listenToProducts();
                filterBtn.textContent = 'عرض آخر 3 ساعات';
            }
        });

        function toggleModal(modal, show) {
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            } else {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        // Initial load
        listenToProducts();
    </script>
</body>
                    </html>
                    
